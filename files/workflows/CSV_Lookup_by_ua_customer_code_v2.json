{
  "name": "CSV Lookup by ua_customer_code (v2)",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "code-assign-1",
              "name": "code",
              "value": "055402090",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [720, 200],
            "name": "Find in CSV by ua_customer_code",
            "id": "code-search-1-v2"
          },
          {
            "parameters": {
              "jsCode": "// Group rows (items) by manager and by customer, produce one item per manager with sheets array\nconst inputs = $input.all() || [] ;\nvar rows = [];\nfor (var ii = 0; ii < inputs.length; ii++) {\n  var nodeItem = inputs[ii] && inputs[ii][0] ? inputs[ii][0].json : (inputs[ii] && inputs[ii].json ? inputs[ii].json : null);\n  if (!nodeItem) continue;\n  rows.push(nodeItem);\n}\nif (rows.length === 0) return [];\nvar byManager = {};\nfor (var i=0;i<rows.length;i++) {\n  var r = rows[i] || {};\n  var manager = (r.manager !== undefined && r.manager !== null) ? r.manager.toString().trim() : (r._manager || 'No Manager');\n  var code = (r.ua_customer_code !== undefined && r.ua_customer_code !== null) ? r.ua_customer_code.toString().replace(/\\.0+$/,'') : (r.customer_code || r._customer_code || 'unknown');\n  var cname = (r.customer_name !== undefined && r.customer_name !== null) ? r.customer_name.toString() : (r._customer_name || code);\n  r._customer_code = code; r._customer_name = cname; r._manager = manager;\n  if (!byManager[manager]) byManager[manager] = { manager: manager, customers: {} };\n  if (!byManager[manager].customers[code]) byManager[manager].customers[code] = { sheetName: cname, rows: [] };\n  byManager[manager].customers[code].rows.push(r);\n}\nvar out = [];\nfor (var m in byManager) {\n  var mgrEntry = byManager[m];\n  var sheets = [];\n  for (var c in mgrEntry.customers) {\n    var cust = mgrEntry.customers[c];\n    var cleanRows = cust.rows.map(function(rr){ var copy = {}; for (var k in rr) { if (k.indexOf('_')===0) continue; copy[k]=rr[k]; } return copy; });\n    sheets.push({ sheetName: cust.sheetName || c, rows: cleanRows });\n  }\n  out.push({ json: { manager: mgrEntry.manager, sheets: sheets } });\n}\nreturn out;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [980, 200],
            "name": "Group By Manager",
            "id": "group-by-manager-v1"
          },
          {
            "parameters": {
              "options": {
                "batchSize": 1
              }
            },
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [1220, 200],
            "name": "Loop Managers",
            "id": "split-managers-v1"
          },
          {
            "parameters": {
              "assignments": {
                "assignments": [
                  {
                    "id": "file-assign-1",
                    "name": "fileName",
                    "value": "={{ $json.manager.replace(/[/\\\\?%*:|\\\"<>]/g, '_') + '.xlsx' }}",
                    "type": "string"
                  }
                ]
              },
              "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3,
            "position": [1460, 200],
            "name": "Prepare FileName",
            "id": "set-filename-v1"
          },
          {
            "parameters": {
              "path": "/files/{{ $json.fileName }}",
              "binaryPropertyName": "data"
            },
            "type": "n8n-nodes-base.writeBinaryFile",
            "typeVersion": 1,
            "position": [1700, 200],
            "name": "Write JSON Summary (fallback)",
            "id": "write-json-summary-v1"
          }
        ],
        "connections": {
          "Set Code Example": { "main": [ [ { "node": "Read CSV File", "type": "main", "index": 0 } ] ] },
          "Read CSV File": { "main": [ [ { "node": "Find in CSV by ua_customer_code", "type": "main", "index": 0 } ] ] },
          "Find in CSV by ua_customer_code": { "main": [ [ { "node": "Group By Manager", "type": "main", "index": 0 } ] ] },
          "Group By Manager": { "main": [ [ { "node": "Loop Managers", "type": "main", "index": 0 } ] ] },
          "Loop Managers": { "main": [ [ { "node": "Prepare FileName", "type": "main", "index": 0 } ], [] ] },
          "Prepare FileName": { "main": [ [ { "node": "Write JSON Summary (fallback)", "type": "main", "index": 0 } ] ] },
          "Write JSON Summary (fallback)": { "main": [ [] ] }
        },
        "active": false,
        "settings": { "executionOrder": "v1" },
        "id": "CSV-Lookup-ua_customer_code-2025-v2"
      }
